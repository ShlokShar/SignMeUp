<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SignMeUp</title>
  <link href="../static/css/output.css" rel="stylesheet">
  <link href="../static/css/animation.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,400;0,500;0,600;0,700;0,800;0,900;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
  <style>
    html {
      scroll-behavior: smooth;
    }
  </style>
</head>
<body class="flex min-h-screen w-full flex-col items-center space-y-[76px]">
  <!--NAVIGATION BAR-->
  <nav class="w-full flex flex-row justify-between px-[20px] py-[12px] items-center">
    <div class="flex flex-row space-x-[8px] justify-center items-center">
      <img src="../static/img/logo.png" width="48px" height="48px">
      <p class="font-poppins font-semibold text-[24px]">SignMeUp</p>
    </div>
    <div class="absolute left-1/2 transform -translate-x-1/2 flex flex-row space-x-[8px] items-center text-[16px] text-[#5A5A5A] font-poppins font-medium">
      <a class="cursor-pointer" href="">Inspiration</a>
      <div class="w-[4px] h-[4px] bg-gray-500 rounded-full"></div>
      <a class="cursor-pointer" href="https://hello-world-2025.devpost.com/?ref_feature=challenge&ref_medium=your-open-hackathons&ref_content=Submissions+open&_gl=1*crt6k8*_gcl_au*NjM5ODg0MjA4LjE3NTgzOTU4Mzc.*_ga*ODY5MzE5NTQ4LjE3NTAwOTIyOTc.*_ga_0YHJK3Y10M*czE3NTg0Mjc2OTkkbzYkZzAkdDE3NTg0Mjc2OTkkajYwJGwwJGgw">Devpost</a>
      <div class="w-[4px] h-[4px] bg-gray-500 rounded-full"></div>
      <a class="cursor-pointer" href="https://github.com/ShlokShar/SignMeUp">Source Code</a>
    </div>
    <a class="flex flex-row space-x-[14px] justify-between items-center text-[16px] cursor-pointer hover:translate-y-0.5 duration-200" href="#upload-container">
      <div class="bg-black px-3.5 py-2 text-white rounded-[15px]">Try Now</div>
    </a>
  </nav>
  
  <div class="flex flex-col space-y-[38px] items-center">
    <div class="flex flex-col space-y-[12px] items-center">
      <div class="flex flex-row space-x-2 bg-accent py-2 pl-2 pr-3 rounded-full items-center">
        <img class="bg-white rounded-full p-2 w-10 h-10" src="../static/img/deaf.png" alt="ear icon">
        <p class="font-poppins italic text-[16px]">Made for the 11 million deaf Americans</p>
      </div>
      <p class="font-poppins font-medium text-[60px] leading-[70px] max-w-[600px] text-center">Stories Should Be Understood by All</p>
      <p class="font-regular text-[18px] leading-[20px] max-w-[600px] text-center text-[#696969] ">Sign Me Up makes speech captions clear for ASL, so no one misses out.</p>
    </div>
    <a href="#upload-container" class="cursor-pointer font-poppins font-semibold text-[20px] relative inline-flex items-center justify-center p-4 px-6 py-3 overflow-hidden text-accent transition duration-300 ease-out border-2 border-accent rounded-full shadow-md group hover:translate-y-0.5">
      <span class="absolute inset-0 flex items-center justify-center w-full h-full text-primary duration-300 -translate-x-full bg-white group-hover:translate-x-0 ease"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg></span>
      <span class="absolute flex items-center justify-center w-full h-full bg-primary text-white transition-all duration-500 transform group-hover:translate-x-full ease">Upload Video</span>
      <span class="relative invisible">Upload Video</span>
    </a>
  </div>
  
  <div class="gallery flex flex-row space-x-2 justify-center">
    <div class="flex flex-col w-1/3 items-end justify-between space-y-2">
      <img src="../static/img/image 4.png">
      <img src="../static/img/image 5.png">
      <img src="../static/img/image 9.png">
    </div>
    <div class="flex flex-col w-1/3 items-center justify-between space-y-2">
      <img src="../static/img/image 1.png">
      <img src="../static/img/image 10.png">
    </div>
    <div class="flex flex-col w-1/3 items-start justify-between space-y-2">
      <img src="../static/img/image 6.png">
      <img src="../static/img/image 2.png">
      <img src="../static/img/image 11.png">
    </div>
  </div>
  
  <div id="upload-container" class="upload-container flex flex-col items-center space-y-[38px] relative">
    <p class="font-poppins font-semibold text-[22px]">Upload</p>
    <div class="relative">
      <div class="absolute inset-0 rounded-[20px] bg-gradient-to-r from-primary to-accent blur-2xl opacity-40"></div>
      <label 
        for="file-upload" 
        id="drop-area"
        class="relative cursor-pointer flex flex-col justify-center items-center w-[600px] h-[400px] bg-white border-2 border-dashed rounded-[20px] border-[#B4B4B4] space-y-4"
      >
        <img class="upload-icon" src="../static/img/upload.png" width="60px">
        <p class="text-[14px]">Drag & Drop your file here or <span class="underline font-bold">Choose file</span></p>
      </label>
    </div>
    <input id="file-upload" type="file" class="hidden" accept="video/*" />
  </div>

  <!-- Video and ASL Translation Display -->
  <div id="video-display" class="hidden flex flex-col items-center space-y-6 w-full py-8">
    <h2 class="font-poppins font-semibold text-[22px]">Your Uploaded Video</h2>
    <div class="flex justify-center items-center w-full">
      <video 
        id="uploaded-video"
        class="max-w-4xl w-full h-auto rounded-lg shadow-lg" 
        controls 
        preload="metadata"
      >
        <source id="video-source" src="" type="video/mp4">
        Your browser does not support the video tag.
      </video>
    </div>
    
    <!-- Loading indicator -->
    <div id="processing-indicator" class="hidden flex flex-col items-center space-y-4">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
      <p class="font-poppins text-[16px] text-[#696969]">Processing video for ASL translation...</p>
    </div>
    
    <!-- ASL Translation Result in H1 -->
    <h1 id="asl-result" class="hidden font-poppins text-[32px] font-bold text-center max-w-4xl leading-relaxed mb-8"></h1>
    
    <!-- ASL Sign Images Display -->
    <div id="asl-signs-container" class="hidden w-full max-w-6xl">
      <h3 class="font-poppins font-semibold text-[20px] mb-6 text-center">ASL Sign Images</h3>
      
      <!-- Slideshow Container -->
      <div class="relative bg-gray-50 rounded-lg p-8 min-h-[300px] flex items-center justify-center">
        <!-- Single sign display area -->
        <div id="current-sign" class="text-center transition-all duration-500 ease-in-out opacity-0 z-10 relative">
          <!-- Sign content will be inserted here -->
        </div>
        
        <!-- Navigation controls -->
        <button id="prev-sign" class="absolute left-4 top-1/2 transform -translate-y-1/2 bg-white hover:bg-gray-100 rounded-full p-3 shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>
        
        <button id="next-sign" class="absolute right-4 top-1/2 transform -translate-y-1/2 bg-white hover:bg-gray-100 rounded-full p-3 shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </button>
        
        <!-- Auto-play toggle -->
        <button id="play-pause" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-blue-600 hover:bg-blue-700 text-white rounded-full p-3 shadow-lg transition-all">
          <svg id="play-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h1m4 0h1m-6-8h8a2 2 0 012 2v8a2 2 0 01-2 2H8a2 2 0 01-2-2V6a2 2 0 012-2z"></path>
          </svg>
          <svg id="pause-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </button>
      </div>
      
      <!-- Progress indicators -->
      <div id="sign-indicators" class="flex justify-center mt-4 space-x-2">
        <!-- Dots will be added here dynamically -->
      </div>
      
      <!-- Sign counter -->
      <div id="sign-counter" class="text-center mt-2 text-gray-600 text-sm">
        <!-- Counter will be updated here -->
      </div>
    </div>
  </div>

  <script>
    let aslDictionary = {};
    let dictionaryLoaded = false;
    let currentSigns = [];
    let currentSignIndex = 0;
    let autoPlayInterval = null;
    let isPlaying = false;

    document.addEventListener('DOMContentLoaded', function() {
      const fileUpload = document.getElementById('file-upload');
      const dropArea = document.getElementById('drop-area');
      const videoDisplay = document.getElementById('video-display');
      const videoSource = document.getElementById('video-source');
      const uploadedVideo = document.getElementById('uploaded-video');
      const processingIndicator = document.getElementById('processing-indicator');
      const aslResult = document.getElementById('asl-result');
      const aslSignsContainer = document.getElementById('asl-signs-container');
      const currentSign = document.getElementById('current-sign');
      const prevButton = document.getElementById('prev-sign');
      const nextButton = document.getElementById('next-sign');
      const playPauseButton = document.getElementById('play-pause');
      const playIcon = document.getElementById('play-icon');
      const pauseIcon = document.getElementById('pause-icon');
      const signIndicators = document.getElementById('sign-indicators');
      const signCounter = document.getElementById('sign-counter');

      // Load ASL dictionary from CSV
      loadASLDictionary();

      // Navigation event listeners
      prevButton.addEventListener('click', () => {
        if (currentSignIndex > 0) {
          showSign(currentSignIndex - 1);
        }
      });

      nextButton.addEventListener('click', () => {
        if (currentSignIndex < currentSigns.length - 1) {
          showSign(currentSignIndex + 1);
        }
      });

      playPauseButton.addEventListener('click', toggleAutoPlay);

      // Handle file selection
      fileUpload.addEventListener('change', function(e) {
        handleFile(e.target.files[0]);
      });

      // Handle drag and drop
      dropArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropArea.classList.add('border-primary');
      });

      dropArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        dropArea.classList.remove('border-primary');
      });

      dropArea.addEventListener('drop', function(e) {
        e.preventDefault();
        dropArea.classList.remove('border-primary');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFile(files[0]);
        }
      });

      function handleFile(file) {
        if (file && file.type.startsWith('video/')) {
          // Show video preview
          const videoURL = URL.createObjectURL(file);
          videoSource.src = videoURL;
          uploadedVideo.load();
          videoDisplay.classList.remove('hidden');
          
          // Show processing indicator
          processingIndicator.classList.remove('hidden');
          aslResult.classList.add('hidden');
          aslSignsContainer.classList.add('hidden');
          
          // Stop any ongoing slideshow
          stopAutoPlay();
          
          // Update drop area
          const dropText = dropArea.querySelector('p');
          dropText.innerHTML = `âœ… Video uploaded: ${file.name}`;
          
          // Scroll to video
          videoDisplay.scrollIntoView({ behavior: 'smooth' });
          
          // Upload and process file
          uploadAndProcess(file);
        } else {
          alert('Please upload a valid video file.');
        }
      }

      function uploadAndProcess(file) {
        const formData = new FormData();
        formData.append('file', file);

        fetch('/upload', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          processingIndicator.classList.add('hidden');
          
          if (data.result) {
            // Display the result text
            aslResult.textContent = data.result;
            aslResult.classList.remove('hidden');
            
            // Display ASL sign images as slideshow
            displayASLSigns(data.result);
          } else {
            alert('Error processing video: ' + (data.error || 'No result returned'));
          }
        })
        .catch(error => {
          processingIndicator.classList.add('hidden');
          console.error('Error:', error);
          alert('Error uploading file. Please try again.');
        });
      }

      async function loadASLDictionary() {
        try {
          const response = await fetch('/static/ASL-LEX View Data.csv');
          if (!response.ok) {
            console.warn('ASL dictionary CSV not found. Sign images will not be displayed.');
            return;
          }
          
          const csvContent = await response.text();
          const lines = csvContent.split('\n');
          const headers = lines[0].split(',').map(h => h.replace(/^"|"$/g, '').trim());
          
          // Find column indices
          const entryIdIndex = headers.findIndex(h => h.toLowerCase().includes('entry id') || h === 'Entry ID');
          const handshapeImageIndex = headers.findIndex(h => h.toLowerCase().includes('handshape image') || h === 'Handshape Image');
          const lexicalClassIndex = headers.findIndex(h => h.toLowerCase().includes('lexical class') || h === 'Lexical Class');
          const dominantTranslationIndex = headers.findIndex(h => h.toLowerCase().includes('dominant translation') || h === 'Dominant Translation');
          
          if (entryIdIndex === -1 || handshapeImageIndex === -1) {
            console.warn('Required CSV columns not found');
            return;
          }

          // Process each row
          for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            const row = parseCSVLine(line);
            if (row.length <= Math.max(entryIdIndex, handshapeImageIndex)) continue;
            
            const entryId = row[entryIdIndex] ? row[entryIdIndex].replace(/^"|"$/g, '').trim() : '';
            const handshapeImage = row[handshapeImageIndex] ? row[handshapeImageIndex].replace(/^"|"$/g, '').trim() : '';
            
            if (entryId && handshapeImage && handshapeImage !== 'N/A' && handshapeImage.includes('src=')) {
              const word = entryId.replace(/_/g, ' ').toLowerCase();
              
              let originalImageUrl = null;
              const match = handshapeImage.match(/src="([^"]+)"/);
              if (match) {
                originalImageUrl = match[1];
              }

              if (originalImageUrl) {
                const lexicalClass = row[lexicalClassIndex] ? row[lexicalClassIndex].replace(/^"|"$/g, '').trim() : 'Unknown';
                const translation = row[dominantTranslationIndex] ? row[dominantTranslationIndex].replace(/^"|"$/g, '').trim() : null;
                
                aslDictionary[word] = {
                  word: word,
                  entryId: entryId,
                  imageUrl: originalImageUrl,
                  lexicalClass: lexicalClass,
                  translation: (translation && translation !== "N/A") ? translation : null
                };
              }
            }
          }
          
          dictionaryLoaded = true;
          console.log(`ASL dictionary loaded: ${Object.keys(aslDictionary).length} signs`);
          
        } catch (error) {
          console.warn('Could not load ASL dictionary:', error);
        }
      }

      function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        let i = 0;
        
        while (i < line.length) {
          const char = line[i];
          
          if (char === '"') {
            if (inQuotes && line[i + 1] === '"') {
              current += '"';
              i++;
            } else {
              inQuotes = !inQuotes;
            }
          } else if (char === ',' && !inQuotes) {
            result.push(current);
            current = '';
          } else {
            current += char;
          }
          i++;
        }
        
        result.push(current);
        return result;
      }

      function displayASLSigns(resultText) {
        if (!dictionaryLoaded) {
          console.log('ASL dictionary not loaded, skipping sign display');
          return;
        }

        // Clean and split the result text into words
        const words = resultText.toLowerCase()
          .replace(/[^\w\s]/g, '')
          .split(/\s+/)
          .filter(word => word.length > 0);

        // Create sign data array - include all words
        currentSigns = words.map(word => {
          const signData = aslDictionary[word];
          return {
            word: word,
            signData: signData
          };
        });

        if (currentSigns.length === 0) return;

        // Create indicators
        createIndicators();
        
        // Show first sign
        currentSignIndex = 0;
        showSign(0);
        
        // Show the signs container
        aslSignsContainer.classList.remove('hidden');
        
        // Set up video event listeners for synchronized playback
        setupVideoSyncedPlayback();
      }

      function createIndicators() {
        signIndicators.innerHTML = '';
        currentSigns.forEach((_, index) => {
          const dot = document.createElement('button');
          dot.className = 'w-3 h-3 rounded-full bg-gray-300 hover:bg-gray-400 transition-colors';
          dot.addEventListener('click', () => showSign(index));
          signIndicators.appendChild(dot);
        });
      }

      function showSign(index) {
        if (index < 0 || index >= currentSigns.length) return;
        
        currentSignIndex = index;
        const { word, signData } = currentSigns[index];
        
        // Fade out
        currentSign.classList.add('opacity-0');
        
        setTimeout(() => {
          // Update content
          if (signData && signData.imageUrl) {
            // Word has ASL image - show image + lexical class
            currentSign.innerHTML = `
              <div class="mb-4">
                <img src="${signData.imageUrl}" alt="${word}" class="w-32 h-32 mx-auto object-contain rounded-lg shadow-lg" 
                     onerror="this.parentElement.innerHTML='<div class=\\'w-32 h-32 mx-auto flex items-center justify-center bg-gray-100 rounded-lg shadow-lg\\'><span class=\\'text-gray-400\\'>Image unavailable</span></div>';">
              </div>
              <div class="text-xl font-semibold text-gray-800">${signData.lexicalClass}</div>
            `;
          } else {
            // Word has no ASL image - show only the word as text
            currentSign.innerHTML = `
              <div class="text-2xl font-bold text-gray-800">${word.toUpperCase()}</div>
            `;
          }
          
          // Fade in
          currentSign.classList.remove('opacity-0');
        }, 250);
        
        // Update indicators
        updateIndicators();
        
        // Update counter
        signCounter.textContent = `${index + 1} of ${currentSigns.length}`;
        
        // Update navigation buttons
        prevButton.disabled = index === 0;
        nextButton.disabled = index === currentSigns.length - 1;
      }

      function updateIndicators() {
        const dots = signIndicators.children;
        for (let i = 0; i < dots.length; i++) {
          dots[i].className = i === currentSignIndex 
            ? 'w-3 h-3 rounded-full bg-blue-600 transition-colors'
            : 'w-3 h-3 rounded-full bg-gray-300 hover:bg-gray-400 transition-colors';
        }
      }

      function startAutoPlay() {
        if (autoPlayInterval) clearInterval(autoPlayInterval);
        isPlaying = true;
        playIcon.classList.add('hidden');
        pauseIcon.classList.remove('hidden');
        
        autoPlayInterval = setInterval(() => {
          if (currentSignIndex < currentSigns.length - 1) {
            showSign(currentSignIndex + 1);
          } else {
            showSign(0); // Loop back to start
          }
        }, 2000); // Default 2 seconds per sign
      }

      function startAutoPlayWithVideoTiming() {
        if (autoPlayInterval) clearInterval(autoPlayInterval);
        
        // Get video duration
        const videoDuration = uploadedVideo.duration;
        
        if (!videoDuration || !isFinite(videoDuration) || currentSigns.length === 0) {
          console.log('Could not get video duration, using default timing');
          startAutoPlay();
          return;
        }
        
        // Calculate timing: video duration (in seconds) divided by number of signs
        const signDuration = (videoDuration / currentSigns.length) * 1000; // Convert to milliseconds
        
        // Set reasonable bounds (minimum 0.5 seconds, maximum 10 seconds per sign)
        const clampedDuration = Math.max(500, Math.min(10000, signDuration));
        
        console.log(`Video duration: ${videoDuration.toFixed(2)}s, Signs: ${currentSigns.length}, Duration per sign: ${(clampedDuration/1000).toFixed(2)}s`);
        
        isPlaying = true;
        playIcon.classList.add('hidden');
        pauseIcon.classList.remove('hidden');
        
        autoPlayInterval = setInterval(() => {
          if (currentSignIndex < currentSigns.length - 1) {
            showSign(currentSignIndex + 1);
          } else {
            showSign(0); // Loop back to start
          }
        }, clampedDuration);
      }

      function setupVideoSyncedPlayback() {
        // Remove any existing event listeners to prevent duplicates
        uploadedVideo.removeEventListener('play', handleVideoPlay);
        uploadedVideo.removeEventListener('pause', handleVideoPause);
        uploadedVideo.removeEventListener('ended', handleVideoEnded);
        uploadedVideo.removeEventListener('seeked', handleVideoSeeked);
        
        // Add event listeners for video synchronization
        uploadedVideo.addEventListener('play', handleVideoPlay);
        uploadedVideo.addEventListener('pause', handleVideoPause);
        uploadedVideo.addEventListener('ended', handleVideoEnded);
        uploadedVideo.addEventListener('seeked', handleVideoSeeked);
        
        console.log('Video-synced playback setup complete. ASL animation will start when video plays.');
      }

      function handleVideoPlay() {
        // Start ASL slideshow when video starts playing
        if (uploadedVideo.readyState >= 1) {
          startAutoPlayWithVideoTiming();
        } else {
          uploadedVideo.addEventListener('loadedmetadata', startAutoPlayWithVideoTiming, { once: true });
        }
      }

      function handleVideoPause() {
        // Pause ASL slideshow when video is paused
        stopAutoPlay();
      }

      function handleVideoEnded() {
        // Stop ASL slideshow when video ends
        stopAutoPlay();
        // Reset to first sign
        showSign(0);
      }

      function handleVideoSeeked() {
        // If video is seeking while playing, restart slideshow with current timing
        if (!uploadedVideo.paused && !uploadedVideo.ended) {
          handleVideoPlay();
        }
      }

      function stopAutoPlay() {
        if (autoPlayInterval) {
          clearInterval(autoPlayInterval);
          autoPlayInterval = null;
        }
        isPlaying = false;
        playIcon.classList.remove('hidden');
        pauseIcon.classList.add('hidden');
      }

      function toggleAutoPlay() {
        if (isPlaying) {
          stopAutoPlay();
        } else {
          startAutoPlay();
        }
      }
    });
  </script>

  <script src="../static/js/script.js"></script>
</body>
</html>